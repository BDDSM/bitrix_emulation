Процедура ВыполнитьОбновлениеКаталога(ИДСеансаОбмена,Пользователь,МассивИменФайлов) Экспорт
	
	// В общем виде схема такова:
	// 1. Определяем список файлов.
	// 2. Как-то их пытаемся упорядочить, если надо
	// 3. Обрабатываем каждый
	
	Для Каждого ИмяФайла Из МассивИменФайлов Цикл
		
		СостояниеОбработкиФайла = "success";
		
		Файл = Новый Файл(ИмяФайла);
		
		Если нрег(Файл.ИмяБезРасширения) = "import"
			И нрег(Файл.Расширение) = ".xml" Тогда
			
			//вот его мы грузить умеем. Сделаем это.
			
			//ИмяФайлаПарсера = "c:\pricat\V2\CMLReader\CMLReader.epf";
			//ИмяФайлаМенеджераES = "c:\pricat\V2\ES_Manage.epf";
			//
			//МенеджерЭластика = ВнешниеОбработки.Создать(ИмяФайлаМенеджераES,Ложь);
			//Парсер = ВнешниеОбработки.Создать(ИмяФайлаПарсера,Ложь);
			
			МенеджерЭластика = Обработки.ES_Manage.Создать();
			Парсер = Обработки.ЗагрузкаКаталогаCML.Создать();
			
			Попытка
				
				//ИДКаталога = "123";//откуда берем? Из файлика? Тогда прочитать надо. Пока возьмем из пользователя.
				ИДКаталога = Строка(ПользователиИнформационнойБазы.ТекущийПользователь().УникальныйИдентификатор);
				
				//сюда надо еще передавать или ID каталога, или ID компании.
				РазобранныйКаталог = Парсер.РазобратьXMLВТаблицыЗначений(Файл.ПолноеИмя);
				МенеджерЭластика.ПоместитьРазобранныйКаталогВЭластик(РазобранныйКаталог);//разумеется, файла может уже и не быть
				
				
				// Напрашивается или ручное добавление каталогов через админку с присвоением им ID
				// или добавление автоматом, но тогда только commerceml
				// короче, в парсер надо точно добавить ID компании и ID каталога
				
			Исключение
				_Ошибка = ОписаниеОшибки();
				ВызватьИсключение(_Ошибка);
			КонецПопытки;	
			
		КонецЕсли;
		
		Запись = РегистрыСведений.СостояниеОбработкиЗагруженныхФайлов.СоздатьМенеджерЗаписи();
		
		Запись.Пользователь		= Пользователь;
		Запись.ИДСеансаОбмена	= ИДСеансаОбмена;
		Запись.ИмяФайла			= Файл.ПолноеИмя;
		
		Запись.Прочитать();
		
		Запись.Состояние	= СостояниеОбработкиФайла;
		Запись.ДанныеФайла	= Неопределено;
		Запись.Записать();
		
		УдалитьФайлы(Файл.ПолноеИмя);// и почистим за собой
		
	КонецЦикла;	
	
КонецПроцедуры
