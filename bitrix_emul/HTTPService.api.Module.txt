Функция __Описание()
	
	//Последовательность загрузки в общем виде такова:
	
	// 1. GET /upload?type=catalog&mode=checkauth
	// Ждет в ответ "success"
	
	// 2. GET /upload?type=catalog&mode=init
	// Ждет в ответ примерно такое:
	// zip=yes
	// file_limit=-1
	
	// 3. POST /upload?type=catalog&mode=file&filename=v8_A7D2_69.zip
	// Ждет в ответ "success"
	
	// 4. GET /upload?type=catalog&mode=import&filename=v8_A7D2_69.zip
	// Ждет в ответ "success", когда файл наконец будет обработан Битриксом. Выполняется до тех пор, пока сервер отвечает "progress".
	// Дальше сервер должен ответить "success" или "failure". Это важно, чтоб клиент не повис намертво, там даже в ОФ нет ОбработкаПрерыванияПользователя!!!
	
	//Одновременный импорт с нескольких машин вроде как не допускается. Возможно, стоит подумать о его жестком запрете.
	//Нарезка файла на куски пока не задействована. Смотреть встроенную функцию "РазделитьФайл" и ее зеркало
	
КонецФункции

Функция rootGET(Запрос)
	
	ЗаписатьСодержаниеЗапросаВЖурнал(Запрос,"GET");
	
	Если НЕ Запрос.ПараметрыЗапроса.Получить("type")="catalog" Тогда
		
		//не умеем такое обрабатывать
		Ответ = Новый HTTPСервисОтвет(500);
		Ответ.УстановитьТелоИзСтроки("Умеем работать только в режиме выгрузки каталога, ничего более");
		Возврат Ответ;
		
	КонецЕсли;	
	
	Если Запрос.ПараметрыЗапроса.Получить("mode")="checkauth" Тогда
		//?type=catalog&mode=checkauth
		
		//проверить корректность и написать в ответ "success" (это точно) либо "fail" (предполагаю)
		//пока просто будем считать, что все ок всегда
		
		ТекстОтвета = "success";//успешно
		//ТекстОтвета = ТекстОтвета+Символы.ПС+"КукиИмя";//хз что с этим делать. Видимо, пускай пока авторизуется заново на каждый чих
		//ТекстОтвета = ТекстОтвета+Символы.ПС+"КукиЗначение";//хз что с этим делать. Видимо, пускай пока авторизуется заново на каждый чих
		
		Ответ = Новый HTTPСервисОтвет(200);
		Ответ.УстановитьТелоИзСтроки("success");
		
	ИначеЕсли Запрос.ПараметрыЗапроса.Получить("mode")="init" Тогда
		//?type=catalog&mode=init
		//здесь надо рассказать получателю, как мы умеем работать
		
		ТекстОтвета = "zip=yes";//разрешим сжатие файлов
		ТекстОтвета = ТекстОтвета+Символы.ПС+"file_limit=-1";//без ограничений
//		ТекстОтвета = ТекстОтвета+Символы.ПС+"file_limit=10240";//по частям. Здесь надо как-то умудриться в POST запросе добавлять куски файла к исходному. Но лучше это оставить на потом.
		
		Ответ = Новый HTTPСервисОтвет(200);
		Ответ.УстановитьТелоИзСтроки(ТекстОтвета);
		
	ИначеЕсли Запрос.ПараметрыЗапроса.Получить("mode")="import" Тогда
		//?type=catalog&mode=import&filename=import.xml
		//получатель интересуется, обработали ли мы его файл полностью.
		//Внимание! Он спрашивает не имя куска и не имя архива, а конкретный файл внутри архива
		
		ТекстОтвета = "success";//"failure"/"progress"
		//пока скажем, что все ок. А потом необходимо приделать проверку. 
		//Разумеется, названия файлов могут пересекаться по пользователям. Надо писать прямо в какую-то таблицу/РС.
		
		Ответ = Новый HTTPСервисОтвет(200);
		Ответ.УстановитьТелоИзСтроки(ТекстОтвета);
		
	Иначе //ну просто так
		
		Ответ = Новый HTTPСервисОтвет(500);
		Ответ.УстановитьТелоИзСтроки("unknown command");
		
	КонецЕсли;
	
	Возврат Ответ;
	
КонецФункции

Функция rootPOST(Запрос)
	
	ЗаписатьСодержаниеЗапросаВЖурнал(Запрос,"POST");
	
	Если Запрос.ПараметрыЗапроса.Получить("mode")="file" Тогда
		//?type=catalog&mode=file&filename=v8_A7D2_69.zip
		
		//здесь надо просто забрать файл
		ИмяФайла=Запрос.ПараметрыЗапроса.Получить("filename");
		
		ДД=Запрос.ПолучитьТелоКакДвоичныеДанные();
		
		ИмяСохраненногоФайла = КаталогСохраненияПолученныхФайлов()+ИмяФайла;
		ДД.Записать(ИмяСохраненногоФайла);
		//Теперь надо как-то умудриться обработать этот файл, с привязкой к конкретной компании и каталогу.
		//А после обработки уведомить об этом клиента, если он еще тут.
		
		НачатьОбработкуФайлов(ИмяСохраненногоФайла);//Фоновое задание, видимо
		
		СтрокаПараметров = "success";
		
		Ответ = Новый HTTPСервисОтвет(200);
		Ответ.УстановитьТелоИзСтроки(СтрокаПараметров);
		Возврат Ответ;
		
	Иначе
		
		Ответ = Новый HTTPСервисОтвет(500);
		Ответ.УстановитьТелоИзСтроки("unknown command");
		Возврат Ответ;
		
	КонецЕсли;
	
КонецФункции

Функция СтруктураВСтроку(Структура)
	
	Результат = "";
	
	Для Каждого Эл Из Структура Цикл
		Результат = Результат+?(Результат="","?","&")+Эл.Ключ+"="+Эл.Значение;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции	

Функция КаталогСохраненияПолученныхФайлов()
	
	//можно уже делить пользователей по каталогам, например.
	
	СИ = Новый СистемнаяИнформация;
	Если СИ.ТипПлатформы = ТипПлатформы.Windows_x86 
		Или СИ.ТипПлатформы = ТипПлатформы.Windows_x86_64 Тогда
		РазделительКаталогов = "\";
	Иначе
		РазделительКаталогов = "/";
	КонецЕсли;	
	
	КаталогUpload = КаталогВременныхФайлов()+"upload";
	КаталогUpload = "c:\pricat\V2\bitrix_emul\received";//отладка
	СоздатьКаталогПриНеобходимости(КаталогUpload);
	
	//опираемся на то, что для платформенного пользователя всегда существует элемент в справочнике.
	КаталогПользователя = КаталогUpload+РазделительКаталогов+СокрЛП(ПользователиИнформационнойБазы.ТекущийПользователь().Имя);
	СоздатьКаталогПриНеобходимости(КаталогПользователя);
	
	Возврат КаталогПользователя+РазделительКаталогов;
	
КонецФункции	

Процедура ЗаписатьСодержаниеЗапросаВЖурнал(Запрос,Метод)

	Возврат;//хватит отладки, пора в прод
	
	СтрокаВЖР =	""+Запрос.БазовыйURL+"
				|"+Запрос.ОтносительныйURL+"
				|"+СтруктураВСтроку(Запрос.ПараметрыURL)+"
				|"+СтруктураВСтроку(Запрос.ПараметрыЗапроса)+"
				|"+ТипЗнч(Запрос.ПолучитьТелоКакДвоичныеДанные());

	ЗаписьЖурналаРегистрации(""+Метод+" запрос",,,,СтрокаВЖР);
	
КонецПроцедуры

Процедура НачатьОбработкуФайлов(ИмяСохраненногоФайла)
	
	// Так, здесь может быть только один файл. Но внезапно это может быть ZIP.
	
	
	
КонецПроцедуры	

Процедура СоздатьКаталогПриНеобходимости(Каталог)
	
	Ф = Новый Файл(Каталог);
	Если НЕ Ф.Существует() Тогда
		СоздатьКаталог(Каталог);
	ИначеЕсли НЕ Ф.ЭтоКаталог()	Тогда
		ВызватьИсключение "Пытаемся создать каталог "+Каталог+", а уже существует файл с таким именем";
	КонецЕсли;
	
КонецПроцедуры	